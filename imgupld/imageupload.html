<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆçµå©šå¼ï¼‰</title>
  <style>
    :root { --bg:#fafafa; --fg:#111; --muted:#666; --brand:#2f80ed; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{max-width:720px;margin:0 auto;padding:20px;}
    .card{background:#fff;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.08);padding:20px;}
    .title{font-size:1.25rem;font-weight:700;margin:0 0 8px;}
    .sub{color:var(--muted);font-size:.95rem;margin:0 0 16px;}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.6em;
         width:100%;padding:16px;border-radius:12px;border:none;background:var(--brand);color:#fff;
         font-size:1.05rem;font-weight:700;letter-spacing:.02em;}
    .btn:active{transform:scale(.99)}
    .hint{font-size:.85rem;color:var(--muted);margin-top:10px}
    .thumbs{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px}
    .thumbs img{width:100%;height:72px;object-fit:cover;border-radius:8px;background:#eee}
    .progress{margin-top:14px;font-size:.95rem;line-height:1.6}
    .ok{color:#0a7a28}
    .err{color:#b00020}
    .footer{margin-top:18px;font-size:.8rem;color:var(--muted);text-align:center}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 class="title">å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h1>
      <p class="sub">ã‚¢ãƒ«ãƒãƒ ã‹ã‚‰è¤‡æ•°é¸æŠOKã€‚å¤§é‡ã«é¸ã‚“ã§ã‚‚è‡ªå‹•ã§å°åˆ†ã‘é€ä¿¡ã—ã¾ã™ã€‚</p>

      <button id="pick" class="btn">ğŸ“· ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
      <input id="file" type="file" accept="image/*" multiple style="display:none" />

      <div class="hint">â€»Wi-Fiæ¨å¥¨ã€‚å¤§ãã„ç”»åƒã¯è‡ªå‹•ã§ç¸®å°ãƒ»åœ§ç¸®ã—ã¦é€ã‚Šã¾ã™ã€‚</div>

      <div id="thumbs" class="thumbs" aria-live="polite"></div>
      <div id="status" class="progress mono"></div>

      <!-- éè¡¨ç¤ºiframeã‚¿ãƒ¼ã‚²ãƒƒãƒˆ -->
      <iframe name="hiddenFrame" id="hiddenFrame" style="display:none"></iframe>

      <!-- é€ä¿¡ç”¨ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒãƒƒãƒã”ã¨ã«ä¸­èº«ã‚’ä½œã‚Šæ›¿ãˆã¾ã™ï¼‰ -->
      <form id="uploadForm" action="WEB_APP_URL" method="POST" target="hiddenFrame">
        <div id="hiddenFields"></div>
      </form>
    </div>
    <div class="footer">Powered by Google Apps Script</div>
  </div>

  <script>
    // ====== è¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰ ======
    const WEB_APP_URL     = 'https://script.google.com/d/1KtycmCYS2byKfrSCY-hM_2huJzXlJ-zIgrQPeNaYYI2rqwGEsvbrkSvO/edit?usp=sharing';
    const SIMPLE_API_KEY  = 'set-a-random-string-here'; // Code.gsã¨åŒã˜å€¤

    const MAX_EDGE_PX     = 2000;  // æœ€å¤§è¾ºï¼ˆç¸¦æ¨ªã®ã†ã¡å¤§ãã„æ–¹ï¼‰ã‚’ã“ã®å€¤ã¾ã§ç¸®å°
    const JPEG_QUALITY    = 0.85;  // 0.0ã€œ1.0
    const POST_LIMIT_MB   = 10;    // 1ãƒãƒƒãƒã®æ¦‚ç®—ä¸Šé™ï¼ˆbase64æ–‡å­—åˆ—åˆè¨ˆãƒ»ãƒ¡ã‚¿å«ã‚€ï¼‰
    const FILES_PER_BATCH = 25;    // 1ãƒãƒƒãƒã‚ãŸã‚Šã®æœ€å¤§æšæ•°ï¼ˆç«¯æœ«ãƒ¡ãƒ¢ãƒªå¯¾ç­–ï¼‰
    const MAX_RETRY       = 2;     // é€ä¿¡å¤±æ•—æ™‚ã®ãƒªãƒˆãƒ©ã‚¤å›æ•°

    // ====== è¦ç´  ======
    const pickBtn = document.getElementById('pick');
    const fileInp = document.getElementById('file');
    const thumbs  = document.getElementById('thumbs');
    const status  = document.getElementById('status');
    const form    = document.getElementById('uploadForm');
    const hidden  = document.getElementById('hiddenFields');
    const iframe  = document.getElementById('hiddenFrame');

    form.action = WEB_APP_URL;

    pickBtn.addEventListener('click', () => fileInp.click());

    fileInp.addEventListener('change', async () => {
      const files = Array.from(fileInp.files || []);
      thumbs.innerHTML = '';
      status.textContent = '';

      if (!files.length) return;

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆè»½é‡ï¼‰
      for (const f of files.slice(0, 24)) { // å…ˆé ­24æšã ã‘è¡¨ç¤ºï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é…æ…®ï¼‰
        const url = URL.createObjectURL(f);
        const img = document.createElement('img');
        img.src = url;
        img.alt = f.name;
        thumbs.appendChild(img);
      }

      try {
        status.textContent = 'æº–å‚™ä¸­ï¼ˆç¸®å°ãƒ»åœ§ç¸®ãƒ»ãƒãƒƒãƒåˆ†å‰²ï¼‰â€¦';

        // é€æ¬¡å‡¦ç†ã§ãƒ¡ãƒ¢ãƒªæ¸©å­˜
        const payloads = [];
        let processed = 0;

        for (const f of files) {
          const p = await fileToResizedBase64(f, MAX_EDGE_PX, JPEG_QUALITY);
          payloads.push(p);
          processed++;
          if (processed % 5 === 0 || processed === files.length) {
            status.textContent = `æº–å‚™ä¸­â€¦ ${processed}/${files.length} æš`;
            await microDelay();
          }
        }

        // ãƒãƒƒãƒåˆ†å‰²
        const batches = makeBatches(payloads, POST_LIMIT_MB, FILES_PER_BATCH);

        // é€ä¿¡ãƒ«ãƒ¼ãƒ—
        let sentCount = 0;
        for (let i = 0; i < batches.length; i++) {
          const batch = batches[i];
          status.textContent = `ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦ ãƒãƒƒãƒ ${i+1}/${batches.length}ï¼ˆ${sentCount}/${payloads.length} æšå®Œäº†ï¼‰`;

          const ok = await submitBatchViaForm(batch, { retries: MAX_RETRY });
          if (!ok) {
            status.innerHTML = `<span class="err">ä¸€éƒ¨ã®ãƒãƒƒãƒé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</span><br>å®Œäº†ï¼š${sentCount} / ${payloads.length} æš`;
            return;
          }
          sentCount += batch.length;
          status.textContent = `ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦ ãƒãƒƒãƒ ${i+1}/${batches.length} å®Œäº†ï¼ˆ${sentCount}/${payloads.length} æšï¼‰`;
          await microDelay(200);
        }

        status.innerHTML = `<span class="ok">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼š${sentCount} æš</span>`;
        fileInp.value = '';
      } catch (e) {
        console.error(e);
        status.innerHTML = `<span class="err">ã‚¨ãƒ©ãƒ¼ï¼š${String(e)}</span>`;
      } finally {
        hidden.innerHTML = '';
      }
    });

    // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======

    function microDelay(ms = 60) { return new Promise(r => setTimeout(r, ms)); }

    function sanitizeFilename(name) {
      return (name || 'photo.jpg')
        .replace(/[\\\/:*?"<>|#%&{}$!'@+=`]/g, '_')
        .replace(/\s+/g, '_')
        .slice(-180);
    }

    function approxSizeMBOfBase64(str) {
      // base64ã¯ 4/3 ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã€‚æ¦‚ç®—ã§ãƒã‚¤ãƒˆæ•° = (len * 3/4)
      const bytes = Math.floor((str.length * 3) / 4);
      return bytes / (1024 * 1024);
    }

    // ç”»åƒã‚’canvasã§ç¸®å°ï¼†JPEGåŒ–â†’ base64ã¨mime/filenameã‚’è¿”ã™
    function fileToResizedBase64(file, maxEdge, quality) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          try {
            let { width, height } = img;
            const scale = Math.min(1, maxEdge / Math.max(width, height));
            if (scale < 1) {
              width = Math.round(width * scale);
              height = Math.round(height * scale);
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d', { alpha: false });
            ctx.drawImage(img, 0, 0, width, height);

            // iOS HEICå¯¾ç­–ï¼šJPEGã§å‡ºåŠ›
            const dataUrl = canvas.toDataURL('image/jpeg', quality);
            const base64 = dataUrl.split(',')[1];

            resolve({
              base64,
              mime: 'image/jpeg',
              filename: sanitizeFilename(file.name?.replace(/\.(heic|HEIC|heif|HEIF)$/,'') || `photo_${Date.now()}.jpg`) + '.jpg'
            });
          } catch (err) { reject(err); }
        };
        img.onerror = reject;

        const fr = new FileReader();
        fr.onload = () => { img.src = fr.result; };
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    // åˆè¨ˆã‚µã‚¤ã‚ºãŒä¸Šé™ã‚’è¶…ãˆãªã„ã‚ˆã†ã«é…åˆ—ã‚’åŒºåˆ‡ã‚‹
    function makeBatches(items, limitMB, maxItems) {
      const batches = [];
      let cur = [], curMB = 0;
      for (const it of items) {
        const sz = approxSizeMBOfBase64(it.base64) + 0.05; // ãƒ¡ã‚¿åˆ†ãƒãƒ¼ã‚¸ãƒ³
        const wouldExceed = (curMB + sz > limitMB) || (cur.length >= maxItems);
        if (wouldExceed && cur.length) {
          batches.push(cur);
          cur = [];
          curMB = 0;
        }
        cur.push(it);
        curMB += sz;
      }
      if (cur.length) batches.push(cur);
      return batches;
    }

    // éè¡¨ç¤ºiframeã«å‘ã‘ã¦ãƒ•ã‚©ãƒ¼ãƒ POSTï¼ˆé…åˆ—ã‚’ã¾ã¨ã‚ã¦é€ã‚‹ï¼‰
    function submitBatchViaForm(batch, { retries = 0 } = {}) {
      return new Promise(resolve => {
        const doOnce = (attempt) => {
          // hidden inputsä½œã‚Šç›´ã—
          hidden.innerHTML = '';
          hidden.appendChild(hiddenInput('key', SIMPLE_API_KEY));

          for (const p of batch) {
            hidden.appendChild(hiddenInput('data', p.base64));
            hidden.appendChild(hiddenInput('filename', p.filename));
            hidden.appendChild(hiddenInput('mimetype', p.mime));
          }

          const onLoad = () => {
            iframe.removeEventListener('load', onLoad);
            resolve(true); // å¿œç­”æœ¬æ–‡ã¯èª­ã¾ãªã„ï¼ˆCORSå›é¿ï¼‰
          };
          iframe.addEventListener('load', onLoad, { once: true });

          // é€ä¿¡
          try { form.submit(); }
          catch (e) {
            iframe.removeEventListener('load', onLoad);
            if (attempt < retries) {
              setTimeout(() => doOnce(attempt + 1), 400 * (attempt + 1));
            } else {
              resolve(false);
            }
            return;
          }

          // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç›£è¦–ï¼ˆå¤±æ•—æ¤œçŸ¥ç”¨ãƒ»GASã®å¿œç­”ãŒæ¥ãªã„å ´åˆï¼‰
          setTimeout(() => {
            // æ—¢ã«loadã§resolveã•ã‚Œã¦ã„ã‚Œã°ä½•ã‚‚ã—ãªã„
            // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«ã€Œæœªå®Œäº†ãªã‚‰ãƒªãƒˆãƒ©ã‚¤ã€
            // ï¼ˆå³å¯†ã«ã‚„ã‚‹ã«ã¯loadæ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’åˆ¥ç®¡ç†ã—ã¦ãã ã•ã„ï¼‰
          }, 60000);
        };
        doOnce(0);
      });
    }

    function hiddenInput(name, value) {
      const i = document.createElement('input');
      i.type = 'hidden'; i.name = name; i.value = value;
      return i;
    }
  </script>
</body>
</html>
