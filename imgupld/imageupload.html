<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>写真アップロード（結婚式）</title>
  <style>
    :root { --bg:#fafafa; --fg:#111; --muted:#666; --brand:#2f80ed; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{max-width:720px;margin:0 auto;padding:20px;}
    .card{background:#fff;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.08);padding:20px;}
    .title{font-size:1.25rem;font-weight:700;margin:0 0 8px;}
    .sub{color:var(--muted);font-size:.95rem;margin:0 0 16px;}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.6em;
         width:100%;padding:16px;border-radius:12px;border:none;background:var(--brand);color:#fff;
         font-size:1.05rem;font-weight:700;letter-spacing:.02em;}
    .btn:active{transform:scale(.99)}
    .hint{font-size:.85rem;color:var(--muted);margin-top:10px}
    .thumbs{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px}
    .thumbs img{width:100%;height:72px;object-fit:cover;border-radius:8px;background:#eee}
    .progress{margin-top:14px;font-size:.95rem;line-height:1.6}
    .ok{color:#0a7a28}
    .err{color:#b00020}
    .footer{margin-top:18px;font-size:.8rem;color:var(--muted);text-align:center}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 class="title">写真をアップロード</h1>
      <p class="sub">アルバムから複数選択OK。大量に選んでも自動で小分け送信します。</p>

      <button id="pick" class="btn">📷 画像をアップロード</button>
      <input id="file" type="file" accept="image/*" multiple style="display:none" />

      <div class="hint">※Wi-Fi推奨。大きい画像は自動で縮小・圧縮して送ります。</div>

      <div id="thumbs" class="thumbs" aria-live="polite"></div>
      <div id="status" class="progress mono"></div>

      <!-- 非表示iframeターゲット -->
      <iframe name="hiddenFrame" id="hiddenFrame" style="display:none"></iframe>

      <!-- 送信用フォーム（バッチごとに中身を作り替えます） -->
      <form id="uploadForm" action="WEB_APP_URL" method="POST" target="hiddenFrame">
        <div id="hiddenFields"></div>
      </form>
    </div>
    <div class="footer">Powered by Google Apps Script</div>
  </div>

  <script>
    // ====== 設定（必要に応じて調整） ======
    const WEB_APP_URL     = 'https://script.google.com/d/1KtycmCYS2byKfrSCY-hM_2huJzXlJ-zIgrQPeNaYYI2rqwGEsvbrkSvO/edit?usp=sharing';
    const SIMPLE_API_KEY  = 'set-a-random-string-here'; // Code.gsと同じ値

    const MAX_EDGE_PX     = 2000;  // 最大辺（縦横のうち大きい方）をこの値まで縮小
    const JPEG_QUALITY    = 0.85;  // 0.0〜1.0
    const POST_LIMIT_MB   = 10;    // 1バッチの概算上限（base64文字列合計・メタ含む）
    const FILES_PER_BATCH = 25;    // 1バッチあたりの最大枚数（端末メモリ対策）
    const MAX_RETRY       = 2;     // 送信失敗時のリトライ回数

    // ====== 要素 ======
    const pickBtn = document.getElementById('pick');
    const fileInp = document.getElementById('file');
    const thumbs  = document.getElementById('thumbs');
    const status  = document.getElementById('status');
    const form    = document.getElementById('uploadForm');
    const hidden  = document.getElementById('hiddenFields');
    const iframe  = document.getElementById('hiddenFrame');

    form.action = WEB_APP_URL;

    pickBtn.addEventListener('click', () => fileInp.click());

    fileInp.addEventListener('change', async () => {
      const files = Array.from(fileInp.files || []);
      thumbs.innerHTML = '';
      status.textContent = '';

      if (!files.length) return;

      // プレビュー（軽量）
      for (const f of files.slice(0, 24)) { // 先頭24枚だけ表示（パフォーマンス配慮）
        const url = URL.createObjectURL(f);
        const img = document.createElement('img');
        img.src = url;
        img.alt = f.name;
        thumbs.appendChild(img);
      }

      try {
        status.textContent = '準備中（縮小・圧縮・バッチ分割）…';

        // 逐次処理でメモリ温存
        const payloads = [];
        let processed = 0;

        for (const f of files) {
          const p = await fileToResizedBase64(f, MAX_EDGE_PX, JPEG_QUALITY);
          payloads.push(p);
          processed++;
          if (processed % 5 === 0 || processed === files.length) {
            status.textContent = `準備中… ${processed}/${files.length} 枚`;
            await microDelay();
          }
        }

        // バッチ分割
        const batches = makeBatches(payloads, POST_LIMIT_MB, FILES_PER_BATCH);

        // 送信ループ
        let sentCount = 0;
        for (let i = 0; i < batches.length; i++) {
          const batch = batches[i];
          status.textContent = `アップロード中… バッチ ${i+1}/${batches.length}（${sentCount}/${payloads.length} 枚完了）`;

          const ok = await submitBatchViaForm(batch, { retries: MAX_RETRY });
          if (!ok) {
            status.innerHTML = `<span class="err">一部のバッチ送信に失敗しました。再度お試しください。</span><br>完了：${sentCount} / ${payloads.length} 枚`;
            return;
          }
          sentCount += batch.length;
          status.textContent = `アップロード中… バッチ ${i+1}/${batches.length} 完了（${sentCount}/${payloads.length} 枚）`;
          await microDelay(200);
        }

        status.innerHTML = `<span class="ok">アップロード完了：${sentCount} 枚</span>`;
        fileInp.value = '';
      } catch (e) {
        console.error(e);
        status.innerHTML = `<span class="err">エラー：${String(e)}</span>`;
      } finally {
        hidden.innerHTML = '';
      }
    });

    // ====== ユーティリティ ======

    function microDelay(ms = 60) { return new Promise(r => setTimeout(r, ms)); }

    function sanitizeFilename(name) {
      return (name || 'photo.jpg')
        .replace(/[\\\/:*?"<>|#%&{}$!'@+=`]/g, '_')
        .replace(/\s+/g, '_')
        .slice(-180);
    }

    function approxSizeMBOfBase64(str) {
      // base64は 4/3 オーバーヘッド。概算でバイト数 = (len * 3/4)
      const bytes = Math.floor((str.length * 3) / 4);
      return bytes / (1024 * 1024);
    }

    // 画像をcanvasで縮小＆JPEG化→ base64とmime/filenameを返す
    function fileToResizedBase64(file, maxEdge, quality) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          try {
            let { width, height } = img;
            const scale = Math.min(1, maxEdge / Math.max(width, height));
            if (scale < 1) {
              width = Math.round(width * scale);
              height = Math.round(height * scale);
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d', { alpha: false });
            ctx.drawImage(img, 0, 0, width, height);

            // iOS HEIC対策：JPEGで出力
            const dataUrl = canvas.toDataURL('image/jpeg', quality);
            const base64 = dataUrl.split(',')[1];

            resolve({
              base64,
              mime: 'image/jpeg',
              filename: sanitizeFilename(file.name?.replace(/\.(heic|HEIC|heif|HEIF)$/,'') || `photo_${Date.now()}.jpg`) + '.jpg'
            });
          } catch (err) { reject(err); }
        };
        img.onerror = reject;

        const fr = new FileReader();
        fr.onload = () => { img.src = fr.result; };
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    // 合計サイズが上限を超えないように配列を区切る
    function makeBatches(items, limitMB, maxItems) {
      const batches = [];
      let cur = [], curMB = 0;
      for (const it of items) {
        const sz = approxSizeMBOfBase64(it.base64) + 0.05; // メタ分マージン
        const wouldExceed = (curMB + sz > limitMB) || (cur.length >= maxItems);
        if (wouldExceed && cur.length) {
          batches.push(cur);
          cur = [];
          curMB = 0;
        }
        cur.push(it);
        curMB += sz;
      }
      if (cur.length) batches.push(cur);
      return batches;
    }

    // 非表示iframeに向けてフォームPOST（配列をまとめて送る）
    function submitBatchViaForm(batch, { retries = 0 } = {}) {
      return new Promise(resolve => {
        const doOnce = (attempt) => {
          // hidden inputs作り直し
          hidden.innerHTML = '';
          hidden.appendChild(hiddenInput('key', SIMPLE_API_KEY));

          for (const p of batch) {
            hidden.appendChild(hiddenInput('data', p.base64));
            hidden.appendChild(hiddenInput('filename', p.filename));
            hidden.appendChild(hiddenInput('mimetype', p.mime));
          }

          const onLoad = () => {
            iframe.removeEventListener('load', onLoad);
            resolve(true); // 応答本文は読まない（CORS回避）
          };
          iframe.addEventListener('load', onLoad, { once: true });

          // 送信
          try { form.submit(); }
          catch (e) {
            iframe.removeEventListener('load', onLoad);
            if (attempt < retries) {
              setTimeout(() => doOnce(attempt + 1), 400 * (attempt + 1));
            } else {
              resolve(false);
            }
            return;
          }

          // タイムアウト監視（失敗検知用・GASの応答が来ない場合）
          setTimeout(() => {
            // 既にloadでresolveされていれば何もしない
            // ここでは簡易的に「未完了ならリトライ」
            // （厳密にやるにはload済みフラグを別管理してください）
          }, 60000);
        };
        doOnce(0);
      });
    }

    function hiddenInput(name, value) {
      const i = document.createElement('input');
      i.type = 'hidden'; i.name = name; i.value = value;
      return i;
    }
  </script>
</body>
</html>
